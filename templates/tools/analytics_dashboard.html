{% extends "base.html" %}
{% set title = title or "Analytics Dashboard" %}

{% block head_extra %}
{{ super() }} {# Ensure base.html's head_extra is included if it has common items #}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script> 
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0/dist/chartjs-adapter-moment.min.js"></script> 
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&display=swap');

    :root {
        --font-sans: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        --font-mono: "Roboto Mono", SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

        --primary-50: #F0F9FF; --primary-100: #E0F2FE; --primary-200: #BAE6FD; --primary-300: #7DD3FC;
        --primary-400: #38BDF8; --primary-500: #0EA5E9; --primary-600: #0284C7; /* Main Primary */
        --primary-700: #0369A1; --primary-800: #075985; --primary-900: #0C4A6E;
        --primary-rgb: {{ app.config.get('THEME_PRIMARY_RGB', '2, 132, 199') }}; /* Ensure this is defined if used */

        --neutral-50: #F8FAFC; --neutral-100: #F1F5F9; --neutral-200: #E2E8F0;
        --neutral-300: #CBD5E1; --neutral-400: #94A3B8; --neutral-500: #64748B;
        --neutral-600: #475569; --neutral-700: #334155; --neutral-800: #1E293B; 
        --neutral-900: #0F172A;

        --success-500: #10B981; --success-600: #059669; --success-glow: rgba(16, 185, 129, 0.15);
        --warning-500: #F59E0B; --warning-600: #D97706; --warning-glow: rgba(245, 158, 11, 0.15);
        --danger-500: #EF4444;  --danger-600: #DC2626;  --danger-glow: rgba(239, 68, 68, 0.15);

        --page-bg: var(--neutral-100);
        --card-bg: #FFFFFF;
        --card-border: var(--neutral-200);
        --card-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03);
        --card-shadow-hover: 0 10px 15px -3px rgba(var(--primary-rgb),0.07), 0 4px 6px -2px rgba(var(--primary-rgb),0.05);
        
        --radius-sm: 0.25rem; --radius-md: 0.375rem; --radius-lg: 0.5rem; --radius-xl: 0.75rem;
        --transition-theme: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body { font-family: var(--font-sans); background-color: var(--page-bg); color: var(--neutral-700); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    .app-content { background-color: transparent; padding: 1.5rem; }

    .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--neutral-200); }
    .dashboard-title { font-size: 1.875rem; font-weight: 700; color: var(--neutral-800); letter-spacing: -0.03em; margin:0; }

    .filters-panel { background-color: var(--card-bg); border-radius: var(--radius-xl); box-shadow: var(--card-shadow); margin-bottom: 2rem; transition: var(--transition-theme); overflow: hidden; }
    .filters-panel-header { padding: 1rem 1.5rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid transparent; transition: border-color var(--transition-theme); }
    .filters-panel-header.open { border-bottom-color: var(--neutral-200); }
    .filters-panel-header h2 { font-size: 1.125rem; font-weight: 600; color: var(--neutral-700); margin:0; }
    .filters-panel-header .fas { color: var(--primary-600); margin-right: 0.6em;}
    .filters-panel-header .toggle-icon { transition: transform var(--transition-theme); color: var(--neutral-500); }
    .filters-panel-header.open .toggle-icon { transform: rotate(180deg); }
    .filters-panel-body { padding: 1.5rem; border-top: 1px solid var(--neutral-200); }
    .filters-panel .form-group { margin-bottom: 1.25rem; }
    .filters-panel .form-control-label { font-size: 0.75rem; font-weight: 500; color: var(--neutral-500); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
    .filters-panel .form-control, .filters-panel .custom-select, #dateRangePickerDisplayAnalytics {
        border-radius: var(--radius-md); border: 1px solid var(--neutral-300);
        background-color: var(--neutral-50); font-size: 0.875rem;
        padding: 0.6rem 1rem; box-shadow: var(--shadow-sm);
        transition: var(--transition-theme); color: var(--neutral-700);
    }
    #dateRangePickerDisplayAnalytics { display: flex; align-items: center; justify-content: space-between; cursor: pointer; } /* Ensure this ID is unique if you have multiple daterangepickers */
    #dateRangePickerDisplayAnalytics i { color: var(--neutral-400); }
    .filters-panel .form-control:focus, .filters-panel .custom-select:focus, #dateRangePickerDisplayAnalytics.active {
        border-color: var(--primary-500);
        box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
        background-color: var(--card-bg);
    }
    .filters-panel .btn { font-weight: 500; padding: 0.6rem 1.25rem; border-radius: var(--radius-md); font-size: 0.875rem; transition: var(--transition-theme); }
    .filters-panel .btn-primary { background-color: var(--primary-600); border-color: var(--primary-600); color: white; } /* Ensure text-on-primary is white or defined */
    .filters-panel .btn-primary:hover { background-color: var(--primary-700); border-color: var(--primary-700); transform: translateY(-1px); box-shadow: 0 2px 8px rgba(var(--primary-rgb), 0.2); }
    .filters-panel .btn-primary .fas { margin-right: 0.5em; }

    .kpi-card { background: linear-gradient(135deg, var(--card-bg) 0%, #fdfdff 100%); border-radius: var(--radius-xl); box-shadow: var(--card-shadow); padding: 1.75rem; text-align: left; transition: var(--transition-theme); min-height: 150px; display: flex; flex-direction: column; justify-content: space-between; position: relative; overflow: hidden; opacity: 0; transform: scale(0.95) translateY(15px); animation: kpiEntry 0.5s ease-out forwards; }
    .kpi-card-row > .col-md-4:nth-child(1) .kpi-card { animation-delay: 0.2s; }
    .kpi-card-row > .col-md-4:nth-child(2) .kpi-card { animation-delay: 0.3s; }
    .kpi-card-row > .col-md-4:nth-child(3) .kpi-card { animation-delay: 0.4s; }
    @keyframes kpiEntry { to { opacity: 1; transform: scale(1) translateY(0); } }
    .kpi-card:hover { transform: translateY(-6px) scale(1.02); box-shadow: var(--card-shadow-hover); }
    .kpi-card::before { content: ''; position: absolute; top: 0; left: 0; width: 5px; height: 100%; background: var(--primary-500); border-top-left-radius: var(--radius-xl); border-bottom-left-radius: var(--radius-xl); }
    .kpi-card .kpi-icon { font-size: 1.5rem; color: var(--primary-500); margin-bottom: 0.75rem; width: 40px; height: 40px; background-color: var(--primary-50); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; }
    .kpi-card .kpi-label { font-size: 0.9rem; color: var(--neutral-500); font-weight: 500; margin-bottom: 0.35rem; }
    .kpi-card .kpi-value { font-family: var(--font-mono); font-size: 2.5rem; font-weight: 700; color: var(--neutral-800); line-height: 1; margin-bottom: 0.5rem; }
    .kpi-card .kpi-value .fas.fa-spinner { font-size: 1.5rem; color: var(--neutral-400); }
    .kpi-card .kpi-subtext { font-size: 0.75rem; color: var(--neutral-400); }

    .chart-container { position: relative; background-color: var(--card-bg); border-radius: var(--radius-xl); box-shadow: var(--card-shadow); padding: 1.25rem; margin-bottom: 2rem; min-height: 380px; display: flex; align-items: center; justify-content: center; opacity: 0; transform: scale(0.98) translateY(15px); animation: chartEntry 0.6s ease-out forwards; }
    .chart-row-1 > .col-lg-4:nth-child(1) .chart-container { animation-delay: 0.3s; }
    .chart-row-1 > .col-lg-4:nth-child(2) .chart-container { animation-delay: 0.35s; }
    .chart-row-1 > .col-lg-4:nth-child(3) .chart-container { animation-delay: 0.4s; }
    .chart-row-2 .chart-container { animation-delay: 0.45s; }
    .chart-row-3 > .col-md-6:nth-child(1) .chart-container { animation-delay: 0.5s; }
    .chart-row-3 > .col-md-6:nth-child(2) .chart-container { animation-delay: 0.55s; }
    .chart-row-4 .chart-container { animation-delay: 0.6s; }
    @keyframes chartEntry { to { opacity: 1; transform: scale(1) translateY(0); } }
    .chart-container canvas { max-width: 100%; }
    .loading-spinner { display: flex; flex-direction: column; align-items: center; color: var(--primary-600); }
    .loading-spinner .fas { font-size: 2rem; margin-bottom: 0.75rem; }
    .loading-spinner span { font-size: 0.9rem; font-weight: 500; color: var(--neutral-500); }
    .chart-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; color: var(--neutral-500); padding: 2rem; }
    .chart-placeholder .fas { font-size: 2.5rem; margin-bottom: 0.75rem; opacity: 0.5; }
    .chart-placeholder span { font-size: 1rem; font-weight: 500; }
    #chartErrorContainer .alert { border-radius: var(--radius-md); font-size: 0.9rem; padding: 0.85rem 1.25rem; border-left-width: 4px; }
    #chartErrorContainer .alert-danger { border-left-color: var(--danger-600) !important; background-color: #FEF2F2; color: #991B1B; }
    .daterangepicker { font-family: var(--font-sans); border-radius: var(--radius-lg); box-shadow: var(--card-shadow); border: 1px solid var(--neutral-200); } /* Updated shadow */
    .daterangepicker .ranges li:hover { background-color: var(--primary-50); }
    .daterangepicker .ranges li.active { background-color: var(--primary-600); color: #fff; }
    .daterangepicker td.active, .daterangepicker td.active:hover { background-color: var(--primary-600); }
    .daterangepicker .applyBtn.btn-primary { background-color: var(--primary-600); border-color: var(--primary-600); }
    .daterangepicker .applyBtn.btn-primary:hover { background-color: var(--primary-700); border-color: var(--primary-700); }
    hr.section-divider { border: none; height: 1px; background-color: var(--neutral-200); margin: 2.5rem 0; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid analytics-dashboard-page">
    <div class="dashboard-header">
        <h1 class="dashboard-title">{{ title }}</h1>
    </div>

    <div class="filters-panel" id="filtersPanelAnalytics"> {# Unique ID for this panel #}
        <div class="filters-panel-header" data-toggle="collapse" href="#filtersCollapseBodyAnalytics" role="button" aria-expanded="true" aria-controls="filtersCollapseBodyAnalytics">
            <h2><i class="fas fa-sliders-h"></i> Chart Filters</h2>
            <i class="fas fa-chevron-down toggle-icon"></i>
        </div>
        <div class="collapse show" id="filtersCollapseBodyAnalytics">
            <div class="filters-panel-body">
                <form id="analyticsFiltersForm">
                    <div class="row">
                        <div class="col-md-4 col-lg-3 form-group">
                            <label for="dateRangePickerDisplayAnalytics" class="form-control-label">Date Range (Created)</label>
                            <div id="dateRangePickerDisplayAnalytics"> {# Unique ID #}
                                <i class="fas fa-calendar-alt text-muted"></i>
                                <span class="flex-grow-1 ml-2">Select date range</span> <i class="fas fa-caret-down text-muted"></i>
                            </div>
                            <input type="hidden" name="start_date" id="analyticsStartDate"> {# Unique ID #}
                            <input type="hidden" name="end_date" id="analyticsEndDate">   {# Unique ID #}
                        </div>
                        <div class="col-md-4 col-lg-2 form-group">
                            <label for="analyticsFilterStatus" class="form-control-label">Status</label>
                            <select id="analyticsFilterStatus" name="status" class="form-control custom-select">
                                <option value="all" selected>All Statuses</option>
                                {% for status_opt in all_statuses %}<option value="{{ status_opt.value }}">{{ status_opt.display }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4 col-lg-2 form-group">
                            <label for="analyticsFilterPriority" class="form-control-label">Priority</label>
                            <select id="analyticsFilterPriority" name="priority" class="form-control custom-select">
                                <option value="all" selected>All Priorities</option>
                                {% for prio_opt in all_priorities %}<option value="{{ prio_opt.value }}">{{ prio_opt.display }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4 col-lg-2 form-group">
                            <label for="analyticsFilterCategory" class="form-control-label">Category</label>
                            <select id="analyticsFilterCategory" name="category_id" class="form-control custom-select">
                                <option value="all" selected>All Categories</option>
                                {% for cat_opt in all_categories %}<option value="{{ cat_opt.id }}">{{ cat_opt.name }}</option>{% endfor %}
                            </select>
                        </div>
                         <div class="col-md-4 col-lg-3 form-group">
                            <label for="analyticsFilterOrganization" class="form-control-label">Organization</label>
                            <select id="analyticsFilterOrganization" name="organization_id" class="form-control custom-select">
                                <option value="all" selected>All Organizations</option>
                                {% for org_opt in all_organizations %}<option value="{{ org_opt.id }}">{{ org_opt.name }}</option>{% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row mt-2">
                        {# --- NEW: Department Filter for Analytics --- #}
                        <div class="col-md-4 col-lg-3 form-group">
                            <label for="analyticsFilterDepartment" class="form-control-label">Department</label>
                            <select id="analyticsFilterDepartment" name="department_id" class="form-control custom-select" disabled>
                                <option value="all" selected>All Departments in Org</option>
                                {# Pre-population if org is selected via URL - handled by Python route passing `initial_departments_for_filter` #}
                                {% if request.args.get('organization_id') and request.args.get('organization_id') not in ['all', '0'] and initial_departments_for_filter %}
                                    {% for dept_opt in initial_departments_for_filter %}
                                        <option value="{{ dept_opt.id }}" {% if request.args.get('department_id') == dept_opt.id|string %}selected{% endif %}>{{ dept_opt.name }}</option>
                                    {% endfor %}
                                {% endif %}
                            </select>
                             <small id="analyticsFilterDepartmentHelp" class="form-text text-muted-custom" {% if request.args.get('organization_id') and request.args.get('organization_id') not in ['all', '0'] %}style="display:none;"{% else %}style="display:block;"{% endif %}>Select an organization first.</small>
                        </div>
                        {# --- END NEW --- #}

                        <div class="col-md-4 col-lg-3 form-group">
                            <label for="analyticsFilterAgent" class="form-control-label">Assigned To</label>
                            <select id="analyticsFilterAgent" name="assigned_to_id" class="form-control custom-select">
                                <option value="all" selected>Any Agent</option>
                                <option value="unassigned">Unassigned</option>
                                {% for agent_opt in all_agents %}<option value="{{ agent_opt.id }}">{{ agent_opt.username }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4 col-lg-2 offset-lg-4 form-group d-flex align-items-end"> {# Adjusted offset for layout #}
                            <button type="button" id="applyAnalyticsFiltersBtn" class="btn btn-primary btn-block">
                                <i class="fas fa-sync-alt"></i> Refresh Charts
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="chartErrorContainer" class="mb-3"></div>
    
    <div class="row mb-4 kpi-card-row">
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="kpi-card">
                <div class="kpi-icon"><i class="fas fa-stopwatch-20"></i></div>
                <div>
                    <div class="kpi-label">Avg. Resolution Time</div>
                    <div id="avgResolutionTimeValue" class="kpi-value"><i class="fas fa-spinner fa-spin"></i></div>
                </div>
                <small id="avgResolutionTicketCount" class="kpi-subtext">(loading...)</small>
            </div>
        </div>
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="kpi-card">
                 <div class="kpi-icon"><i class="fas fa-ticket-alt" style="color: var(--success-500);"></i></div>
                 <div>
                    <div class="kpi-label">Total Tickets (Period)</div>
                    <div id="totalTicketsPeriodValue" class="kpi-value"><i class="fas fa-spinner fa-spin"></i></div>
                </div>
                <small id="totalTicketsPeriodCount" class="kpi-subtext">(loading...)</small>
            </div>
        </div>
         <div class="col-lg-4 col-md-6 mb-4">
            <div class="kpi-card">
                 <div class="kpi-icon"><i class="fas fa-exclamation-circle" style="color: var(--danger-500);"></i></div>
                 <div>
                    <div class="kpi-label">Open Urgent/High</div>
                    <div id="openUrgentHighValue" class="kpi-value"><i class="fas fa-spinner fa-spin"></i></div>
                </div>
                <small id="openUrgentHighCount" class="kpi-subtext">(loading...)</small>
            </div>
        </div>
    </div>

    <hr class="section-divider">

    <div class="row chart-row-1">
        <div class="col-md-6 col-lg-4">
            <div class="chart-container" id="ticketStatusChartContainer">
                <canvas id="ticketStatusChart"></canvas>
                <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><span>Loading...</span></div>
            </div>
        </div>
         <div class="col-md-6 col-lg-4">
            <div class="chart-container" id="severityDistributionChartContainer">
                <canvas id="severityDistributionChart"></canvas>
                <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><span>Loading...</span></div>
            </div>
        </div>
        <div class="col-md-6 col-lg-4">
            <div class="chart-container" id="ticketsByPriorityChartContainer">
                <canvas id="ticketsByPriorityChart"></canvas>
                <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><span>Loading...</span></div>
            </div>
        </div>
    </div>
     <div class="row chart-row-2">
        <div class="col-lg-12">
            <div class="chart-container" id="cumulativeTicketsChartContainer" style="height: 400px;">
                <canvas id="cumulativeTicketsChart"></canvas>
                <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><span>Loading...</span></div>
            </div>
        </div>
    </div>
    <div class="row chart-row-3"> 
        <div class="col-md-6">
            <div class="chart-container" id="ticketsByCategoryChartContainer">
                <canvas id="ticketsByCategoryChart"></canvas>
                <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><span>Loading...</span></div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container" id="ticketsByAgentChartContainer">
                <canvas id="ticketsByAgentChart"></canvas>
                <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><span>Loading...</span></div>
            </div>
        </div>
    </div>
     <div class="row chart-row-4">
        <div class="col-md-8 col-lg-8 offset-md-2 offset-lg-2">
            <div class="chart-container" id="priorityStatusRadarChartContainer" style="height: 450px;">
                <canvas id="priorityStatusRadarChart"></canvas>
                <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><span>Loading...</span></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<script>
    // Chart instances
    let ticketStatusChart, cumulativeTicketsChart, ticketsByCategoryChart, ticketsByPriorityChart, 
        ticketsByAgentChart, severityDistributionChart, priorityStatusRadarChart;
    
    const modernChartColors = [ 
        'rgba(59, 130, 246, 0.8)',  'rgba(16, 185, 129, 0.8)', 'rgba(245, 158, 11, 0.8)',
        'rgba(239, 68, 68, 0.8)',   'rgba(139, 92, 246, 0.8)', 'rgba(236, 72, 153, 0.8)',
        'rgba(22, 163, 74, 0.8)',   'rgba(217, 119, 6, 0.8)'
    ];
    const priorityColors = { 
        'Urgent': 'rgba(239, 68, 68, 0.85)', 'High': 'rgba(245, 158, 11, 0.85)',
        'Medium': 'rgba(59, 130, 246, 0.85)', 'Low': 'rgba(107, 114, 128, 0.85)'
    };
    const severityColors = { 
        'Severity 1 (Critical)': 'rgba(220, 38, 38, 0.9)', 'Severity 2 (High)': 'rgba(249, 115, 22, 0.9)',
        'Severity 3 (Medium)': 'rgba(234, 179, 8, 0.9)', 'Severity 4 (Low)': 'rgba(34, 197, 94, 0.9)',
        'Default': 'rgba(156, 163, 175, 0.9)'
    };

    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.font.size = 11;
    Chart.defaults.color = 'var(--neutral-500)';
    Chart.defaults.borderColor = 'rgba(0,0,0,0.05)'; 

    Chart.defaults.plugins.title.display = true;
    Chart.defaults.plugins.title.font = { size: 15, weight: '600' };
    Chart.defaults.plugins.title.color = 'var(--neutral-700)';
    Chart.defaults.plugins.title.padding = { top: 10, bottom: 20 };
    
    Chart.defaults.plugins.legend.position = 'bottom';
    Chart.defaults.plugins.legend.labels.boxWidth = 12;
    Chart.defaults.plugins.legend.labels.padding = 15;
    Chart.defaults.plugins.legend.labels.font = {size: 11};

    Chart.defaults.plugins.tooltip.enabled = true;
    Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(30, 41, 59, 0.9)';
    Chart.defaults.plugins.tooltip.titleFont = { weight: '600', size: 13 };
    Chart.defaults.plugins.tooltip.bodyFont = { weight: '400', size: 12 };
    Chart.defaults.plugins.tooltip.padding = {top: 10, bottom: 10, left: 12, right: 12};
    Chart.defaults.plugins.tooltip.cornerRadius = 4;
    Chart.defaults.plugins.tooltip.displayColors = true;
    Chart.defaults.plugins.tooltip.boxPadding = 3;

    function showLoadingSpinner(chartContainerId, show) {
        const container = document.getElementById(chartContainerId);
        if (!container) return;
        const spinner = container.querySelector('.loading-spinner');
        const canvas = container.querySelector('canvas');
        if (spinner) spinner.classList.toggle('d-none', !show);
        if (canvas) canvas.style.display = show ? 'none' : 'block';
         // If hiding spinner and no data was loaded, show placeholder (handled in setChartOrNoData)
    }

    function getQueryParams() {
        const params = new URLSearchParams();
        const startDate = document.getElementById('analyticsStartDate').value; // Use unique ID
        const endDate = document.getElementById('analyticsEndDate').value;     // Use unique ID
        const status = document.getElementById('analyticsFilterStatus').value;
        const priority = document.getElementById('analyticsFilterPriority').value;
        const categoryId = document.getElementById('analyticsFilterCategory').value;
        const organizationId = document.getElementById('analyticsFilterOrganization').value;
        const departmentId = document.getElementById('analyticsFilterDepartment').value; // Get department
        const agentId = document.getElementById('analyticsFilterAgent').value;

        if (startDate) params.append('start_date', startDate);
        if (endDate) params.append('end_date', endDate);
        if (status && status !== 'all') params.append('status', status);
        if (priority && priority !== 'all') params.append('priority', priority);
        if (categoryId && categoryId !== 'all' && categoryId !== '0') params.append('category_id', categoryId);
        if (organizationId && organizationId !== 'all' && organizationId !== '0') {
            params.append('organization_id', organizationId);
            // Only add department_id if an organization is selected AND a specific department is chosen
            if (departmentId && departmentId !== 'all' && departmentId !== '0' && !$('#analyticsFilterDepartment').prop('disabled')) {
                params.append('department_id', departmentId);
            }
        }
        if (agentId && agentId !== 'all') params.append('assigned_to_id', agentId);                         
        
        return params.toString();
    }

    async function fetchData(apiFlaskEndpoint, chartContainerId) {
        if (chartContainerId) showLoadingSpinner(chartContainerId, true);
        const queryParams = getQueryParams();
        const fullUrl = `${apiFlaskEndpoint}${queryParams ? '?' + queryParams : ''}`;
        
        try {
            const response = await fetch(fullUrl);
            if (!response.ok) {
                const errorText = await response.text();
                console.error(`HTTP error! Status: ${response.status} for ${apiFlaskEndpoint}. Response: ${errorText.substring(0, 500)}`);
                throw new Error(`HTTP error ${response.status}`);
            }
            const data = await response.json();
            if (chartContainerId) showLoadingSpinner(chartContainerId, false);
            return data;
        } catch (error) {
            console.error(`FetchData Error for ${apiFlaskEndpoint}:`, error);
            const errorContainer = document.getElementById('chartErrorContainer');
            if (errorContainer) {
                const errorMsgHtml = `<div class="alert alert-danger alert-dismissible fade show" role="alert"><strong>Error!</strong> Failed to load data for some charts (${error.message}).<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">Ã—</span></button></div>`;
                if (!errorContainer.innerHTML.includes(error.message)) {
                     errorContainer.insertAdjacentHTML('beforeend', errorMsgHtml);
                }
            }
            if (chartContainerId) {
                showLoadingSpinner(chartContainerId, false);
                const container = document.getElementById(chartContainerId);
                if (container) container.innerHTML = '<div class="chart-placeholder"><i class="fas fa-exclamation-triangle text-danger mr-2"></i>Could not load chart data.</div>';
            }
            return null;
        }
     }

    function destroyChart(chartInstance) { 
        if (chartInstance && typeof chartInstance.destroy === 'function') {
            chartInstance.destroy();
        }
    }

    function setChartOrNoDataMessage(containerId, chartCreationCallback, data) {
        const container = document.getElementById(containerId);
        if (!container) return null;
        let canvas = container.querySelector('canvas');
        // Ensure canvas and spinner exist or recreate them if needed (e.g., after error display)
        if (!canvas) {
            const newCanvas = document.createElement('canvas');
            newCanvas.id = containerId.replace('Container',''); // e.g. ticketStatusChart
            const spinner = document.createElement('div');
            spinner.className = 'loading-spinner d-none'; // Initially hidden
            spinner.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Loading...</span>';
            container.innerHTML = ''; // Clear previous content (like error messages)
            container.appendChild(newCanvas);
            container.appendChild(spinner);
            canvas = newCanvas;
        } else {
            // If canvas exists, ensure spinner is also there or re-add it
            let spinner = container.querySelector('.loading-spinner');
            if (!spinner) {
                spinner = document.createElement('div');
                spinner.className = 'loading-spinner d-none';
                spinner.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Loading...</span>';
                container.appendChild(spinner);
            }
        }


        const hasLabels = data && data.labels && Array.isArray(data.labels) && data.labels.length > 0;
        const hasSimpleDataStructure = hasLabels && data.data && Array.isArray(data.data) && data.data.length === data.labels.length && data.data.some(d => d > 0);
        const hasComplexDataStructure = hasLabels && data.datasets && Array.isArray(data.datasets) && data.datasets.length > 0 &&
                                        data.datasets.every(ds => ds.data && Array.isArray(ds.data) && ds.data.length === data.labels.length) &&
                                        data.datasets.some(ds => ds.data.some(d => d > 0)); // Check if at least one dataset has data

        if (hasLabels && (hasSimpleDataStructure || hasComplexDataStructure)) {
            canvas.style.display = 'block';
            const placeholder = container.querySelector('.chart-placeholder');
            if (placeholder) placeholder.remove();
            return chartCreationCallback(canvas.getContext('2d'), data);
        } else if (data) { 
            container.innerHTML = '<div class="chart-placeholder"><i class="fas fa-chart-pie mr-2"></i><span>No data available for current filters.</span></div>';
        } // Error case is handled by fetchData clearing the container
        return null;
    }

    // --- Chart Rendering Functions (Updated to use new IDs if needed, check Chart.js instantiation) ---
    async function renderTicketStatusChart() {
        destroyChart(ticketStatusChart);
        const data = await fetchData("{{ url_for('analytics_api.ticket_status_distribution') }}", 'ticketStatusChartContainer');
        ticketStatusChart = setChartOrNoDataMessage('ticketStatusChartContainer', (ctx, chartData) => new Chart(ctx, {
            type: 'pie',
            data: { labels: chartData.labels, datasets: [{ data: chartData.data, backgroundColor: modernChartColors, borderColor: 'var(--card-bg)', borderWidth: 2 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { title: { text: 'Ticket Status Distribution' }} }
        }), data);
    }

    async function renderCumulativeTicketsChart() {
        destroyChart(cumulativeTicketsChart);
        const data = await fetchData("{{ url_for('analytics_api.cumulative_tickets_over_time') }}", 'cumulativeTicketsChartContainer');
        cumulativeTicketsChart = setChartOrNoDataMessage('cumulativeTicketsChartContainer', (ctx, chartData) => new Chart(ctx, {
            type: 'line',
            data: { labels: chartData.labels, datasets: [{ label: 'Cumulative Tickets', data: chartData.data, borderColor: 'var(--primary-600)', backgroundColor: 'rgba(var(--primary-rgb), 0.1)', tension: 0.3, fill: true, pointBackgroundColor: 'var(--primary-600)', pointBorderColor: '#fff', pointRadius: 4, pointHoverRadius: 6 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'day', tooltipFormat: 'll', displayFormats: {day: 'MMM D'} }, grid: { display: false } }, y: { beginAtZero: true, ticks: { precision: 0 }, grid: { borderColor: 'var(--neutral-200)', borderDash: [3,3] } } }, plugins: { title: { text: 'Cumulative Ticket Volume' }, legend: {display: false} } }
        }), data);
    }

    async function renderTicketsByCategoryChart() {
        destroyChart(ticketsByCategoryChart);
        const data = await fetchData("{{ url_for('analytics_api.tickets_by_category') }}", 'ticketsByCategoryChartContainer');
        ticketsByCategoryChart = setChartOrNoDataMessage('ticketsByCategoryChartContainer', (ctx, chartData) => new Chart(ctx, {
            type: 'bar',
            data: { labels: chartData.labels, datasets: [{ data: chartData.data, backgroundColor: modernChartColors.map(c => c.replace('0.8', '0.85')), borderColor: modernChartColors.map(c => c.replace('0.8', '1')), borderWidth: 1, borderRadius: 3 }] },
            options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true, ticks: { precision: 0 }, grid: {borderColor: 'var(--neutral-200)', borderDash: [3,3]} }, y: { grid: {display: false} } }, plugins: { title: { text: 'Tickets by Category' }, legend: {display: false} } }
        }), data);
    }
    
    async function renderTicketsByPriorityChart() {
        destroyChart(ticketsByPriorityChart);
        const data = await fetchData("{{ url_for('analytics_api.tickets_by_priority') }}", 'ticketsByPriorityChartContainer');
        ticketsByPriorityChart = setChartOrNoDataMessage('ticketsByPriorityChartContainer', (ctx, chartData) => {
            const backgroundColors = chartData.labels.map(label => priorityColors[label] || modernChartColors[0]);
            return new Chart(ctx, {
                type: 'doughnut',
                data: { labels: chartData.labels, datasets: [{ data: chartData.data, backgroundColor: backgroundColors, borderColor: 'var(--card-bg)', borderWidth: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { title: { text: 'Tickets by Priority' }} }
            });
        }, data);
    }

    async function renderTicketsByAgentChart() {
        destroyChart(ticketsByAgentChart);
        const data = await fetchData("{{ url_for('analytics_api.tickets_by_agent') }}", 'ticketsByAgentChartContainer');
        ticketsByAgentChart = setChartOrNoDataMessage('ticketsByAgentChartContainer', (ctx, chartData) => new Chart(ctx, {
            type: 'bar',
            data: { labels: chartData.labels, datasets: [{ data: chartData.data, backgroundColor: modernChartColors.map(c => c.replace('0.8', '0.85')), borderColor: modernChartColors.map(c => c.replace('0.8', '1')), borderWidth: 1, borderRadius: 3 }] },
            options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true, ticks: { precision: 0 }, grid: {borderColor: 'var(--neutral-200)', borderDash: [3,3]} }, y: { grid: {display: false} } }, plugins: { title: { text: 'Tickets by Assignee' }, legend: {display: false} } }
        }), data);
    }

    async function renderSeverityDistributionChart() {
        destroyChart(severityDistributionChart);
        const data = await fetchData("{{ url_for('analytics_api.severity_distribution') }}", 'severityDistributionChartContainer');
        severityDistributionChart = setChartOrNoDataMessage('severityDistributionChartContainer', (ctx, chartData) => {
            const backgroundColors = chartData.labels.map(label => severityColors[label] || modernChartColors[1]);
            return new Chart(ctx, {
                type: 'doughnut',
                data: { labels: chartData.labels, datasets: [{ data: chartData.data, backgroundColor: backgroundColors, borderColor: 'var(--card-bg)', borderWidth: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { title: { text: 'Severity Distribution' }} }
            });
        }, data);
    }

    async function renderPriorityStatusRadarChart() {
        destroyChart(priorityStatusRadarChart);
        const data = await fetchData("{{ url_for('analytics_api.priority_status_radar_for_category') }}", 'priorityStatusRadarChartContainer');
        let chartTitleText = 'Category Focus: Priority & Status'; // Default title
        if (data && data.category_name) {
             chartTitleText = `${data.category_name}: Priority & Status`;
        } else if (data && (!data.datasets || data.datasets.length === 0 || data.datasets.every(ds => ds.data.every(val => val === 0)))) {
            // This condition is more robust for checking if there's truly no data to display
            chartTitleText += ' (No Data with Current Filters)';
        }

        priorityStatusRadarChart = setChartOrNoDataMessage('priorityStatusRadarChartContainer', (ctx, chartData) => {
            const datasetColors = [ 
                { border: 'rgba(59, 130, 246, 0.9)', bg: 'rgba(59, 130, 246, 0.25)' }, // Primary
                { border: 'rgba(239, 68, 68, 0.9)',  bg: 'rgba(239, 68, 68, 0.25)' },  // Danger
                { border: 'rgba(16, 185, 129, 0.9)', bg: 'rgba(16, 185, 129, 0.25)' },// Success
                { border: 'rgba(245, 158, 11, 0.9)', bg: 'rgba(245, 158, 11, 0.25)' } // Warning
            ];
            if (chartData.datasets) {
                chartData.datasets.forEach((ds, index) => {
                    const colors = datasetColors[index % datasetColors.length];
                    ds.borderColor = colors.border; ds.backgroundColor = colors.bg;
                    ds.pointBackgroundColor = colors.border; ds.pointBorderColor = '#fff';
                    ds.pointHoverBackgroundColor = '#fff'; ds.pointHoverBorderColor = colors.border;
                    ds.borderWidth = 2; ds.pointRadius = 4; ds.pointHoverRadius = 6;
                });
            }
            return new Chart(ctx, {
                type: 'radar', data: chartData,
                options: { responsive: true, maintainAspectRatio: false,
                    scales: { r: { angleLines: { color: 'var(--neutral-200)' }, suggestedMin: 0, pointLabels: { font: {size: 10, weight: '500'}, color: 'var(--neutral-600)'}, grid: { color: 'var(--neutral-200)'}, ticks: { stepSize: 1, precision: 0, backdropColor: 'rgba(255,255,255,0.7)', color: 'var(--neutral-500)'} } },
                    plugins: { title: { text: chartTitleText }, legend: { labels: { usePointStyle: true, pointStyle: 'circle'}}}
                }
            });
        }, data);
    }
    
    async function fetchAndUpdateKPIs() {
        const kpiEndpoints = [
            { id: 'avgResolutionTimeValue', subId: 'avgResolutionTicketCount', url: "{{ url_for('analytics_api.avg_resolution_time') }}", 
              formatter: (data) => ({ value: data.average_resolution_time_str || "N/A", subtext: data.resolved_ticket_count > 0 ? `(Based on ${data.resolved_ticket_count} tickets)` : "(No matching tickets)" }) },
            { id: 'totalTicketsPeriodValue', subId: 'totalTicketsPeriodCount', url: "{{ url_for('analytics_api.total_tickets_in_period') }}",
              formatter: (data) => ({ value: data.total_tickets !== undefined ? data.total_tickets : "N/A", subtext: `(${data.period_description || 'Selected Period'})` }) },
            { id: 'openUrgentHighValue', subId: 'openUrgentHighCount', url: "{{ url_for('analytics_api.open_urgent_high_tickets') }}",
              formatter: (data) => ({ value: data.open_urgent_high_count !== undefined ? data.open_urgent_high_count : "N/A", subtext: "(Currently Open)" }) }
        ];

        kpiEndpoints.forEach(async (kpi) => {
            const valEl = document.getElementById(kpi.id);
            const subEl = document.getElementById(kpi.subId);
            if (valEl) valEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            if (subEl) subEl.textContent = '(loading...)';

            const data = await fetchData(kpi.url, null); // No chart container ID for KPIs
            if (data) {
                const formatted = kpi.formatter(data);
                if (valEl) valEl.textContent = formatted.value;
                if (subEl) subEl.textContent = formatted.subtext;
            } else {
                if (valEl) valEl.textContent = "Error";
                if (subEl) subEl.textContent = "";
            }
        });
    }

    // --- Dependent Department Filter for Analytics ---
    const analyticsOrgFilterEl = $('#analyticsFilterOrganization');
    const analyticsDeptFilterEl = $('#analyticsFilterDepartment');
    const analyticsDeptFilterHelpEl = $('#analyticsFilterDepartmentHelp');

    function updateAnalyticsDepartmentFilter(organizationId, preSelectedDepartmentId = null) {
        if (!analyticsDeptFilterEl.length) return;
        const defaultAllDeptsOptionText = 'All Departments in Org';
        analyticsDeptFilterEl.empty().append($('<option>', { value: 'all', text: defaultAllDeptsOptionText }));

        if (!organizationId || organizationId === 'all' || organizationId === '0') {
            analyticsDeptFilterEl.prop('disabled', true).val('all');
            if (analyticsDeptFilterHelpEl.length) analyticsDeptFilterHelpEl.show();
            return;
        }

        analyticsDeptFilterEl.prop('disabled', false);
        if (analyticsDeptFilterHelpEl.length) analyticsDeptFilterHelpEl.hide();
        analyticsDeptFilterEl.find('option[value="all"]').text('Loading...');
        
        {% set DUMMY_ID_FOR_ANALYTICS_URL = 0 %} 
        let urlTemplate = "{{ url_for('api_departments_for_organization', organization_id=DUMMY_ID_FOR_ANALYTICS_URL) }}";
        const fetchUrl = urlTemplate.replace(String({{ DUMMY_ID_FOR_ANALYTICS_URL }}), organizationId);

        fetch(fetchUrl)
            .then(response => {
                if (!response.ok) return response.json().then(err => { throw new Error(err.detail || `HTTP error ${response.status} fetching depts for analytics`); });
                return response.json();
            })
            .then(data => {
                analyticsDeptFilterEl.empty();
                analyticsDeptFilterEl.append($('<option>', { value: 'all', text: defaultAllDeptsOptionText }));
                let hasActualDepts = false;
                if (data && data.length > 0) {
                    data.forEach(dept => {
                        if (String(dept.id) !== '0') {
                            analyticsDeptFilterEl.append($('<option>', { value: dept.id, text: dept.name }));
                            hasActualDepts = true;
                        } else if (data.length === 1 && String(data[0].id) === '0' && !hasActualDepts) {
                            analyticsDeptFilterEl.find('option[value="all"]').text(dept.name);
                        }
                    });
                }
                if (!hasActualDepts && !(data && data.length === 1 && String(data[0].id) === '0')) {
                    analyticsDeptFilterEl.find('option[value="all"]').text('No Departments Available');
                }
                if (preSelectedDepartmentId && String(preSelectedDepartmentId) !== 'all' && String(preSelectedDepartmentId) !== '0') {
                    if (analyticsDeptFilterEl.find(`option[value="${preSelectedDepartmentId}"]`).length) {
                        analyticsDeptFilterEl.val(String(preSelectedDepartmentId));
                    } else { analyticsDeptFilterEl.val('all'); }
                } else { analyticsDeptFilterEl.val('all'); }
            })
            .catch(error => {
                console.error("Error fetching depts for analytics filter:", error);
                analyticsDeptFilterEl.empty().append($('<option>', { value: 'all', text: 'Error Loading Depts' })).prop('disabled', true);
            });
    }
    // --- END Department Filter Logic ---

    function initializeDateRangePickerAnalytics() { // Unique name
        const storedStartDate = localStorage.getItem('analyticsDashboardStartDate'); // Unique storage key
        const storedEndDate = localStorage.getItem('analyticsDashboardEndDate');
        let start = storedStartDate ? moment(storedStartDate) : moment().subtract(29, 'days');
        let end = storedEndDate ? moment(storedEndDate) : moment();
        if (!moment(start).isValid() || !moment(end).isValid() || moment(start).isAfter(end)) {
            start = moment().subtract(29, 'days'); end = moment();
        }
        function cb(start, end) {
            $('#dateRangePickerDisplayAnalytics span').html(start.format('MMM D, YYYY') + ' - ' + end.format('MMM D, YYYY'));
            $('#analyticsStartDate').val(start.format('YYYY-MM-DD'));
            $('#analyticsEndDate').val(end.format('YYYY-MM-DD'));
            localStorage.setItem('analyticsDashboardStartDate', start.format('YYYY-MM-DD'));
            localStorage.setItem('analyticsDashboardEndDate', end.format('YYYY-MM-DD'));
        }
        $('#dateRangePickerDisplayAnalytics').daterangepicker({ /* ... same daterangepicker options ... */
            startDate: start, endDate: end, maxDate: moment(),
            opens: 'left', 
            locale: { format: 'MMM D, YYYY', applyLabel: 'Apply', cancelLabel: 'Clear', fromLabel: 'From', toLabel: 'To', customRangeLabel: 'Custom Range'},
            ranges: {
               'Today': [moment(), moment()], 'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
               'Last 7 Days': [moment().subtract(6, 'days'), moment()], 'Last 30 Days': [moment().subtract(29, 'days'), moment()],
               'This Month': [moment().startOf('month'), moment().endOf('month')],
               'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
            }
        }, cb);
        cb(start, end); // Initial display
        $('#dateRangePickerDisplayAnalytics').on('apply.daterangepicker', function(ev, picker) { cb(picker.startDate, picker.endDate); });
        $('#dateRangePickerDisplayAnalytics').on('cancel.daterangepicker', function(ev, picker) {
            const defaultStart = moment().subtract(29, 'days'); const defaultEnd = moment(); cb(defaultStart, defaultEnd);
        });
    }
    
    function loadAllChartsAndKPIs() {
        document.getElementById('chartErrorContainer').innerHTML = ''; 
        fetchAndUpdateKPIs();
        renderTicketStatusChart(); renderCumulativeTicketsChart(); renderTicketsByCategoryChart();
        renderTicketsByPriorityChart(); renderTicketsByAgentChart(); renderSeverityDistributionChart(); 
        renderPriorityStatusRadarChart();
    }

    document.addEventListener('DOMContentLoaded', function() {
        initializeDateRangePickerAnalytics(); // Call the uniquely named init function
        
        // Init and event listener for analytics organization filter
        if (analyticsOrgFilterEl.length) {
            analyticsOrgFilterEl.on('change', function() {
                updateAnalyticsDepartmentFilter($(this).val(), 'all'); 
            });
            // Initial population for analytics department filter
            const initialAnalyticsOrgId = new URLSearchParams(window.location.search).get('organization_id') || analyticsOrgFilterEl.val();
            const initialAnalyticsDeptId = new URLSearchParams(window.location.search).get('department_id');
            if (initialAnalyticsOrgId && initialAnalyticsOrgId !== 'all' && initialAnalyticsOrgId !== '0') {
                 if(analyticsOrgFilterEl.val() !== initialAnalyticsOrgId) analyticsOrgFilterEl.val(initialAnalyticsOrgId);
                updateAnalyticsDepartmentFilter(initialAnalyticsOrgId, initialAnalyticsDeptId || 'all');
            } else {
                if (analyticsDeptFilterEl.length) analyticsDeptFilterEl.prop('disabled', true);
                if (analyticsDeptFilterHelpEl.length) analyticsDeptFilterHelpEl.show();
            }
        }

        loadAllChartsAndKPIs(); 
        
        const applyBtn = document.getElementById('applyAnalyticsFiltersBtn'); // Use unique ID
        applyBtn.addEventListener('click', function() {
            applyBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Refreshing...'; // Changed text
            applyBtn.disabled = true;
            loadAllChartsAndKPIs();
            setTimeout(() => { // Simulate processing time, remove in production
                applyBtn.innerHTML = '<i class="fas fa-sync-alt"></i>Refresh Charts';
                applyBtn.disabled = false;
            }, 1200); // Reduced timeout
        });

        const filtersPanelHeader = document.querySelector('#filtersPanelAnalytics .filters-panel-header'); // Use unique ID
        if (filtersPanelHeader) {
            const filtersCollapseBody = document.getElementById('filtersCollapseBodyAnalytics'); // Use unique ID
            const toggleIcon = filtersPanelHeader.querySelector('.toggle-icon');
            $(filtersCollapseBody).on('show.bs.collapse', function () {
                filtersPanelHeader.classList.add('open');
                if(toggleIcon) { toggleIcon.classList.remove('fa-chevron-down'); toggleIcon.classList.add('fa-chevron-up');}
            }).on('hide.bs.collapse', function () {
                 filtersPanelHeader.classList.remove('open');
                if(toggleIcon) { toggleIcon.classList.remove('fa-chevron-up'); toggleIcon.classList.add('fa-chevron-down');}
            });
            if ($(filtersCollapseBody).hasClass('show')) {
                filtersPanelHeader.classList.add('open');
                if(toggleIcon) { toggleIcon.classList.remove('fa-chevron-down'); toggleIcon.classList.add('fa-chevron-up'); }
            } else {
                 if(toggleIcon) { toggleIcon.classList.remove('fa-chevron-up'); toggleIcon.classList.add('fa-chevron-down'); }
            }
        }
    });
</script>
{% endblock %}