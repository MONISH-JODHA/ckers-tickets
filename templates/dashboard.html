{% extends "base.html" %}

{% block head_extra %}
<style>
    :root {
        --primary-color: {{ app.config.get('THEME_PRIMARY_COLOR', '#4A90E2') }};
        --primary-rgb: {{ app.config.get('THEME_PRIMARY_RGB', '74, 144, 226') }};
        --text-dark: #34495e;
        --text-medium: #7f8c8d;
        --text-light: #bdc3c7;
        --page-bg: #f4f7f9; /* Light background */
        --card-bg: #ffffff;
        --card-border: #e3e8ee;
        --card-shadow: 0 3px 15px rgba(0,0,0,0.05);
        --radius-md: 6px;
        --radius-lg: 10px;

        --status-open-bg: #e6fffa; --status-open-text: #00796b; --status-open-dot: #00bfa5;
        --status-inprogress-bg: #e3f2fd; --status-inprogress-text: #1976d2; --status-inprogress-dot: #2196f3;
        --status-onhold-bg: #fff8e1; --status-onhold-text: #f57f17; --status-onhold-dot: #ffab00;
        --status-resolved-bg: #e8f5e9; --status-resolved-text: #2e7d32; --status-resolved-dot: #4caf50;
        --status-closed-bg: #f5f5f5; --status-closed-text: #757575; --status-closed-dot: #9e9e9e;

        --priority-urgent-border: #e53935; /* Red */
        --priority-high-border: #fb8c00;   /* Orange */
        --priority-medium-border: #1e88e5; /* Blue */
        --priority-low-border: #43a047;    /* Green */
    }

    .dashboard-welcome {
        padding: 1.5rem 0;
        margin-bottom: 1.5rem;
    }
    .dashboard-welcome h2 {
        font-weight: 600;
        color: var(--text-dark);
    }
    .dashboard-welcome p {
        color: var(--text-medium);
        font-size: 1.1rem;
    }

    .ticket-card {
        background-color: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: var(--radius-lg);
        margin-bottom: 1.5rem;
        padding: 1.5rem;
        box-shadow: var(--card-shadow);
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        position: relative; /* For priority indicator */
        overflow: hidden; /* For priority indicator */
    }
    .ticket-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.08);
    }

    .ticket-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start; /* Align items to top for multiline titles */
        margin-bottom: 0.75rem;
    }
    .ticket-card-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 0.25rem;
        line-height: 1.3;
    }
    .ticket-card-title a {
        color: inherit;
        text-decoration: none;
    }
    .ticket-card-title a:hover {
        text-decoration: underline;
    }
    .ticket-id {
        font-size: 0.8rem;
        color: var(--text-light);
        font-weight: 500;
    }

    .ticket-status-badge {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0.3em 0.8em;
        border-radius: 20px; /* Pill shape */
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-flex;
        align-items: center;
    }
    .ticket-status-badge .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 6px;
    }
    .status-open { background-color: var(--status-open-bg); color: var(--status-open-text); }
    .status-open .status-dot { background-color: var(--status-open-dot); }
    .status-in-progress { background-color: var(--status-inprogress-bg); color: var(--status-inprogress-text); }
    .status-in-progress .status-dot { background-color: var(--status-inprogress-dot); }
    .status-on-hold { background-color: var(--status-onhold-bg); color: var(--status-onhold-text); }
    .status-on-hold .status-dot { background-color: var(--status-onhold-dot); }
    .status-resolved { background-color: var(--status-resolved-bg); color: var(--status-resolved-text); }
    .status-resolved .status-dot { background-color: var(--status-resolved-dot); }
    .status-closed { background-color: var(--status-closed-bg); color: var(--status-closed-text); }
    .status-closed .status-dot { background-color: var(--status-closed-dot); }

    .ticket-priority-indicator {
        position: absolute;
        top: 0;
        left: 0;
        width: 6px;
        height: 100%;
    }
    .priority-urgent { background-color: var(--priority-urgent-border); }
    .priority-high { background-color: var(--priority-high-border); }
    .priority-medium { background-color: var(--priority-medium-border); }
    .priority-low { background-color: var(--priority-low-border); }


    .ticket-meta {
        font-size: 0.85rem;
        color: var(--text-medium);
        margin-bottom: 0.3rem;
    }
    .ticket-meta .fas {
        margin-right: 0.4em;
        width: 1em; /* Ensure alignment */
    }
    .ticket-meta strong {
        color: var(--text-dark);
        font-weight: 500;
    }
    .ticket-description-preview {
        font-size: 0.9rem;
        color: var(--text-medium);
        margin-top: 0.75rem;
        line-height: 1.5;
        max-height: 3em; /* Approx 2 lines */
        overflow: hidden;
        text-overflow: ellipsis;
        /* Forcing ellipsis on multiline requires more complex CSS or JS, 
           keeping it simple for now or use white-space: nowrap if single line is OK */
    }

    .ticket-actions {
        margin-top: 1rem;
        text-align: right;
    }
    .ticket-actions .btn-sm {
        font-size: 0.8rem;
    }

    .view-all-btn-container {
        text-align: center;
        margin-top: 2rem;
    }

    /* Agent/Admin Dashboard minimal styling */
    .agent-dashboard-section {
        margin-bottom: 2rem;
    }
    .agent-dashboard-section h4 {
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--primary-color);
        display: inline-block;
    }
    .agent-dashboard-list .list-group-item {
        border-left: 3px solid transparent;
        transition: border-left-color 0.2s;
    }
    .agent-dashboard-list .list-group-item:hover {
        border-left-color: var(--primary-color);
        background-color: #f8f9fa;
    }

    /* Admin Dashboard - Stats Cards */
    .admin-stats-card {
        background-color: var(--card-bg);
        border: 1px solid var(--card-border);
        border-left: 4px solid var(--primary-color);
        border-radius: var(--radius-md);
        padding: 1.25rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 5px rgba(0,0,0,0.03);
    }
    .admin-stats-card .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--text-dark);
    }
    .admin-stats-card .stat-label {
        font-size: 0.9rem;
        color: var(--text-medium);
    }
    .admin-stats-card .stat-icon {
        font-size: 1.5rem;
        color: var(--primary-color);
        opacity: 0.7;
    }
    .recent-interactions-list .list-group-item {
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
    }
    .interaction-actor { font-weight: 600; color: var(--primary-color); }
    .interaction-time { font-size: 0.8rem; color: var(--text-light); }

</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    {% if current_user.is_admin %}
        {# --- ADMIN DASHBOARD --- #}
        <div class="dashboard-welcome">
            <h2>Admin Dashboard</h2>
            <p>Overview of the ticket system.</p>
        </div>
        <div class="row">
            <div class="col-md-3">
                <div class="admin-stats-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="stat-value">{{ total_tickets }}</div>
                            <div class="stat-label">Total Tickets</div>
                        </div>
                        <div class="stat-icon"><i class="fas fa-ticket-alt"></i></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="admin-stats-card" style="border-left-color: #28a745;">
                     <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="stat-value">{{ open_tickets }}</div>
                            <div class="stat-label">Open Tickets</div>
                        </div>
                        <div class="stat-icon" style="color: #28a745;"><i class="fas fa-folder-open"></i></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="admin-stats-card" style="border-left-color: #ffc107;">
                     <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="stat-value">{{ inprogress_tickets }}</div>
                            <div class="stat-label">In Progress</div>
                        </div>
                        <div class="stat-icon" style="color: #ffc107;"><i class="fas fa-tasks"></i></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                 <div class="admin-stats-card" style="border-left-color: #007bff;">
                     <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="stat-value">{{ resolved_tickets }}</div>
                            <div class="stat-label">Resolved Tickets</div>
                        </div>
                         <div class="stat-icon" style="color: #007bff;"><i class="fas fa-check-circle"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-3">
             <div class="col-md-7">
                <div class="agent-dashboard-section">
                    <h4>Recent System Interactions</h4>
                    {% if recent_interactions %}
                    <ul class="list-group recent-interactions-list">
                        {% for interaction in recent_interactions %}
                            <li class="list-group-item">
                                <span class="interaction-actor">
                                    {% if interaction.user %}{{ interaction.user.username }}{% elif interaction.interaction_type == 'TICKET_CREATED' and interaction.ticket and interaction.ticket.creator %}{{ interaction.ticket.creator.username }}{% else %}System{% endif %}
                                </span>
                                {% set interaction_desc = interaction.interaction_type.replace('_', ' ').title() %}
                                {% if interaction.details %}
                                    {% if interaction.details.get('field_display_name') %}
                                        changed <strong>{{ interaction.details.field_display_name }}</strong> from "{{ interaction.details.old_value|truncate(20) }}" to "{{ interaction.details.new_value|truncate(20) }}"
                                    {% elif interaction.details.get('comment_id') %}
                                        added a comment
                                    {% elif interaction.details.get('title') and interaction.interaction_type == 'TICKET_CREATED' %}
                                        created ticket: {{ interaction.details.title|truncate(30) }}
                                    {% else %}
                                        {{ interaction_desc }}
                                    {% endif %}
                                {% else %}
                                     {{ interaction_desc }}
                                {% endif %}
                                {% if interaction.ticket %}
                                    on <a href="{{ url_for('view_ticket', ticket_id=interaction.ticket_id) }}">Ticket #{{ interaction.ticket_id }}</a>
                                {% endif %}
                                <span class="float-right interaction-time">{{ interaction.timestamp.strftime('%b %d, %H:%M') }}</span>
                            </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted">No recent interactions recorded.</p>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-5">
                <div class="agent-dashboard-section">
                    <h4>Quick Stats</h4>
                     <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Total Users
                            <span class="badge badge-primary badge-pill">{{ total_users }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Active Categories
                            <span class="badge badge-primary badge-pill">{{ active_category_choices_gdoc|length -1 if active_category_choices_gdoc else 0 }}</span>
                        </li>
                        {# Add more quick stats as needed #}
                    </ul>
                </div>
            </div>
        </div>


    {% elif current_user.is_agent %}
        {# --- AGENT DASHBOARD --- #}
        <div class="dashboard-welcome">
            <h2>Agent Dashboard</h2>
            <p>Manage and track assigned support tickets.</p>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="agent-dashboard-section">
                    <h4><i class="fas fa-user-clock mr-2"></i>Your Assigned Tickets (Unsolved)</h4>
                    {% if my_assigned_tickets %}
                        <ul class="list-group agent-dashboard-list">
                            {% for ticket in my_assigned_tickets %}
                                <li class="list-group-item">
                                    <a href="{{ url_for('view_ticket', ticket_id=ticket.id) }}">{{ ticket.title }}</a>
                                    <small class="d-block text-muted">
                                        Status: {{ ticket.status }} | Priority: {{ ticket.priority }} | Updated: {{ ticket.updated_at.strftime('%b %d, %Y %H:%M') }}
                                    </small>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted">No tickets currently assigned to you that are unsolved.</p>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-6">
                 <div class="agent-dashboard-section">
                    <h4><i class="fas fa-inbox mr-2"></i>Unassigned Open Tickets</h4>
                    {% if unassigned_tickets %}
                         <ul class="list-group agent-dashboard-list">
                            {% for ticket in unassigned_tickets %}
                                 <li class="list-group-item">
                                    <a href="{{ url_for('view_ticket', ticket_id=ticket.id) }}">{{ ticket.title }}</a>
                                     <small class="d-block text-muted">
                                        Priority: {{ ticket.priority }} | Created: {{ ticket.created_at.strftime('%b %d, %Y %H:%M') }}
                                    </small>
                                     <a href="{{ url_for('assign_ticket_to_me', ticket_id=ticket.id) }}" class="btn btn-sm btn-outline-success float-right mt-n3">Assign to Me</a>
                                </li>
                            {% endfor %}
                        </ul>
                        {% if unassigned_tickets|length >= 10 %}
                            <a href="{{ url_for('agent_ticket_list', view_name='unassigned') }}" class="btn btn-sm btn-link mt-2">View all unassigned...</a>
                        {% endif %}
                    {% else %}
                        <p class="text-muted">No unassigned open tickets at the moment.</p>
                    {% endif %}
                </div>
            </div>
        </div>

    {% else %}
        {# --- CLIENT DASHBOARD (IMPROVED) --- #}
        <div class="dashboard-welcome">
            <h2>My Dashboard</h2>
            <p>Welcome back, {{ current_user.username }}! Here's what's happening with your tickets.</p>
        </div>

        <h4><i class="fas fa-history mr-2"></i>My Recent Tickets</h4>
        {% if my_tickets %}
            <div class="row">
                {% for ticket in my_tickets %}
                <div class="col-md-6">
                    <div class="ticket-card">
                        <div class="ticket-priority-indicator priority-{{ ticket.priority|lower }}"></div>
                        <div class="ticket-card-header">
                            <div>
                                <h5 class="ticket-card-title">
                                    <a href="{{ url_for('view_ticket', ticket_id=ticket.id) }}">{{ ticket.title }}</a>
                                </h5>
                                <span class="ticket-id">#{{ ticket.id }}</span>
                            </div>
                            <span class="ticket-status-badge status-{{ ticket.status|lower|replace(' ', '-') }}">
                                <span class="status-dot"></span>{{ ticket.status }}
                            </span>
                        </div>
                        
                        <div class="ticket-meta">
                            <i class="fas fa-layer-group"></i>Category: <strong>{{ ticket.category_ref.name if ticket.category_ref else 'N/A' }}</strong>
                        </div>
                         <div class="ticket-meta">
                             <i class="fas {{ 'fa-exclamation-circle' if ticket.priority == 'Urgent' else ('fa-arrow-alt-circle-up' if ticket.priority == 'High' else ('fa-arrow-alt-circle-right' if ticket.priority == 'Medium' else 'fa-arrow-alt-circle-down')) }}"></i>
                             Priority: <strong>{{ ticket.priority }}</strong>
                        </div>
                        <div class="ticket-meta">
                            <i class="fas fa-user"></i>Assigned: <strong>{{ ticket.assignee.username if ticket.assignee else 'Unassigned' }}</strong>
                        </div>
                        <div class="ticket-meta">
                           <i class="fas fa-clock"></i>Last Updated: <strong>{{ ticket.updated_at.strftime('%b %d, %Y %H:%M') }}</strong>
                        </div>
                        {% if ticket.description %}
                        <p class="ticket-description-preview">{{ ticket.description|striptags|truncate(120) }}</p>
                        {% endif %}
                        <div class="ticket-actions">
                            <a href="{{ url_for('view_ticket', ticket_id=ticket.id) }}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye mr-1"></i>View Details
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle mr-2"></i>You haven't submitted any tickets yet.
                <a href="{{ url_for('create_ticket') }}" class="alert-link ml-2">Create your first ticket now!</a>
            </div>
        {% endif %}

        <div class="view-all-btn-container">
            <a href="{{ url_for('my_tickets') }}" class="btn btn-primary">
                <i class="fas fa-list-ul mr-2"></i>View All My Tickets
            </a>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
{# Add any dashboard-specific JS if needed in the future #}
<script>
    // Example: Simple animation for cards on load
    document.addEventListener('DOMContentLoaded', function() {
        const ticketCards = document.querySelectorAll('.ticket-card');
        ticketCards.forEach((card, index) => {
            card.style.animation = `fadeInUp 0.5s ${index * 0.1}s ease-out forwards`;
            card.style.opacity = '0'; // Start hidden for animation
        });
    });

    // CSS for fadeInUp animation (can be in <style> or external CSS)
    const styleSheet = document.createElement("style");
    styleSheet.type = "text/css";
    styleSheet.innerText = `
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    `;
    document.head.appendChild(styleSheet);
</script>
{% endblock %}