{% extends "base.html" %}

{% block title_tag %}{{ title }} - Ticket CMS{% endblock %}

{% block content_header %}
    {# The main title for the dashboard is handled by the h1 below in the content block #}
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-greeting mb-4">
        <h1 class="content-title">{{ title }}</h1>
        <p class="lead text-secondary">Welcome back, {{ current_user.username }}! Here's what's happening.</p>
    </div>

    {% if current_user.is_admin %}
        <div class="admin-stats-grid">
            {# Total Tickets - Link to all tickets without status filter #}
            <a href="{{ url_for('admin_all_tickets') }}" class="stat-card-link" title="View all tickets">
                <div class="stat-card stat-card-total animated-stat">
                    <div class="stat-card-icon">
                        <i class="fas fa-layer-group"></i>
                    </div>
                    <div class="stat-card-content">
                        <h3 class="stat-card-value">{{ total_tickets }}</h3>
                        <p class="stat-card-label">Total Tickets</p>
                    </div>
                </div>
            </a>

            {# Open Tickets - Link to all tickets filtered by status=Open #}
            <a href="{{ url_for('admin_all_tickets', status='Open') }}" class="stat-card-link" title="View Open tickets">
                <div class="stat-card stat-card-open animated-stat" style="animation-delay: 0.1s;">
                    <div class="stat-card-icon">
                        <i class="fas fa-folder-open"></i>
                    </div>
                    <div class="stat-card-content">
                        <h3 class="stat-card-value">{{ open_tickets }}</h3>
                        <p class="stat-card-label">Open Tickets</p>
                    </div>
                </div>
            </a>

            {# In Progress Tickets - Link to all tickets filtered by status=In Progress #}
            <a href="{{ url_for('admin_all_tickets', status='In Progress') }}" class="stat-card-link" title="View In Progress tickets">
                <div class="stat-card stat-card-progress animated-stat" style="animation-delay: 0.2s;">
                    <div class="stat-card-icon">
                        <i class="fas fa-spinner"></i>
                    </div>
                    <div class="stat-card-content">
                        <h3 class="stat-card-value">{{ inprogress_tickets }}</h3>
                        <p class="stat-card-label">In Progress</p>
                    </div>
                </div>
            </a>

            {# Resolved Tickets - Link to all tickets filtered by status=Resolved #}
            <a href="{{ url_for('admin_all_tickets', status='Resolved') }}" class="stat-card-link" title="View Resolved tickets">
                <div class="stat-card stat-card-resolved animated-stat" style="animation-delay: 0.3s;">
                    <div class="stat-card-icon">
                        <i class="fas fa-check-double"></i>
                    </div>
                    <div class="stat-card-content">
                        <h3 class="stat-card-value">{{ resolved_tickets }}</h3>
                        <p class="stat-card-label">Resolved Tickets</p>
                    </div>
                </div>
            </a>
        </div>
        <div class="mt-4 mb-5 text-center"> 
            <a href="{{ url_for('admin_all_tickets')}}" class="btn btn-lg btn-primary dashboard-action-button">
                <i class="fas fa-list-alt mr-2"></i>View All Tickets
            </a>
        </div>

        {# --- NEW SECTIONS TO FILL SPACE --- #}
        <div class="row dashboard-lower-sections">
            <div class="col-lg-7 col-md-12 mb-4">
                <div class="card dashboard-section-card animated-section" style="animation-delay: 0.4s;">
                    <div class="card-header">
                        <i class="fas fa-bolt mr-2"></i>Quick Actions
                    </div>
                    <div class="card-body">
                        <div class="quick-actions-grid">
                            <a href="{{ url_for('admin_create_edit_user') }}" class="quick-action-item">
                                <i class="fas fa-user-plus fa-2x"></i>
                                <span>New User</span>
                            </a>
                            <a href="{{ url_for('create_ticket') }}" class="quick-action-item">
                                <i class="fas fa-plus-circle fa-2x"></i>
                                <span>New Ticket</span>
                            </a>
                            <a href="{{ url_for('admin_user_list') }}" class="quick-action-item">
                                <i class="fas fa-users-cog fa-2x"></i>
                                <span>Manage Users</span>
                            </a>
                            <a href="{{ url_for('admin_category_list') }}" class="quick-action-item">
                                <i class="fas fa-tags fa-2x"></i>
                                <span>Manage Categories</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-5 col-md-12 mb-4">
                <div class="card dashboard-section-card animated-section" style="animation-delay: 0.5s;">
                    <div class="card-header">
                        <i class="far fa-clock mr-2"></i>Recent System Activity
                    </div>
                    <div class="card-body recent-activity-body">
                        {% if recent_interactions %}
                            <ul class="list-unstyled recent-activity-list">
                                {% for interaction in recent_interactions %}
                                    <li>
                                        <span class="activity-icon">
                                            {% if 'TICKET_CREATED' in interaction.interaction_type %}<i class="fas fa-ticket-alt text-primary"></i>
                                            {% elif 'COMMENT_ADDED' in interaction.interaction_type %}<i class="fas fa-comment-dots text-success"></i>
                                            {% elif 'LOGIN' in interaction.interaction_type or interaction.interaction_type == 'USER_REGISTERED' %}<i class="fas fa-user-check text-success"></i>
                                            {% elif '_CHANGE' in interaction.interaction_type or '_UPDATE' in interaction.interaction_type %}<i class="fas fa-edit text-info"></i>
                                            {% else %}<i class="fas fa-info-circle text-secondary"></i>{% endif %}
                                        </span>
                                        <div class="activity-content">
                                            {% set actor = interaction.user.username if interaction.user else (interaction.ticket.creator.username if interaction.interaction_type == 'TICKET_CREATED' and interaction.ticket and interaction.ticket.creator else 'System') %}
                                            <strong>
                                                {% if 'TICKET_CREATED' in interaction.interaction_type %}Ticket #{{ interaction.ticket_id }} created
                                                {% elif 'COMMENT_ADDED' in interaction.interaction_type %}Comment on Ticket #{{ interaction.ticket_id }}
                                                {% elif interaction.details and interaction.details.field_display_name %}{{ interaction.details.field_display_name }} changed on Ticket #{{ interaction.ticket_id }}
                                                {% else %}{{ interaction.interaction_type.replace('_', ' ')|title }}{% if interaction.ticket_id %} on Ticket #{{ interaction.ticket_id }}{% endif %}{% endif %}
                                            </strong>
                                            {% if interaction.details and interaction.details.field_display_name %}from '{{ interaction.details.old_value|truncate(20, True) if interaction.details.old_value is not none else 'N/A' }}' to '{{ interaction.details.new_value|truncate(20, True) if interaction.details.new_value is not none else 'N/A' }}'{% elif 'COMMENT_ADDED' in interaction.interaction_type and interaction.details and interaction.details.is_internal %} (Internal){% elif 'TICKET_CREATED' in interaction.interaction_type and interaction.details and interaction.details.title %} "{{ interaction.details.title|truncate(30) }}"{% endif %}
                                            <small class="text-muted d-block">{{ interaction.timestamp.strftime('%b %d, %Y %H:%M') }} {% if actor != 'System' %}by {{ actor }}{% endif %}</small>
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <div class="text-center mt-2 no-activity">
                                 <i class="fas fa-stream fa-2x text-muted mb-2"></i>
                                <p class="text-muted">No recent significant activity.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>


    {% elif current_user.is_agent %}
        <div class="agent-dashboard-layout">
            <div class="dashboard-section">
                <h2 class="section-title"><i class="fas fa-user-tie mr-2"></i>My Assigned Tickets (Active)</h2>
                {% if my_assigned_tickets %}
                    <div class="ticket-list-wrapper">
                        {% for ticket in my_assigned_tickets %}
                            {% include '_ticket_item.html' %}
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state-card">
                        <i class="fas fa-clipboard-check fa-3x text-muted mb-3"></i>
                        <p>You have no active tickets assigned to you. Well done!</p>
                    </div>
                {% endif %}
            </div>
            <hr class="my-5">
            <div class="dashboard-section">
                <h2 class="section-title"><i class="fas fa-inbox mr-2"></i>Unassigned Open Tickets (Recent 10)</h2>
                {% if unassigned_tickets %}
                    <div class="ticket-list-wrapper">
                        {% for ticket in unassigned_tickets %}
                            {% include '_ticket_item.html' %}
                        {% endfor %}
                    </div>
                {% else %}
                     <div class="empty-state-card">
                        <i class="fas fa-coffee fa-3x text-muted mb-3"></i>
                        <p>No unassigned open tickets currently. Time for a coffee?</p>
                    </div>
                {% endif %}
            </div>
            <div class="mt-4 text-center">
                <a href="{{ url_for('agent_ticket_list') }}" class="btn btn-lg btn-primary dashboard-action-button">
                    <i class="fas fa-th-list mr-2"></i>View All Agent Tickets
                </a>
            </div>
        </div>

    {% elif current_user.is_client %}
        <div class="dashboard-section">
            <h2 class="section-title"><i class="fas fa-ticket-alt mr-2"></i>My Recent Tickets</h2>
            {% if my_tickets %}
                <div class="ticket-list-wrapper">
                    {% for ticket in my_tickets %}
                        {% include '_ticket_item.html' %}
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state-card text-center">
                    <i class="fas fa-folder-plus fa-3x text-muted mb-3"></i>
                    <p>You have not created any tickets yet.</p>
                    <a href="{{url_for('create_ticket')}}" class="btn btn-success dashboard-action-button">
                        <i class="fas fa-plus-circle mr-1"></i> Create one now!
                    </a>
                </div>
            {% endif %}
            {% if my_tickets %} 
            <div class="mt-4 text-center">
                <a href="{{ url_for('my_tickets') }}" class="btn btn-lg btn-primary dashboard-action-button">
                    <i class="fas fa-list-ul mr-2"></i>View All My Tickets
                </a>
            </div>
            {% endif %}
        </div>
    {% endif %}
</div>
{% endblock %}

{% block head_extra %}
<style>
    .dashboard-container {
        animation: fadeInDashboard 0.5s ease-out forwards;
    }
    @keyframes fadeInDashboard {
        from { opacity: 0; transform: translateY(15px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .dashboard-greeting .content-title {
        font-size: 2rem; 
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }
    .dashboard-greeting .lead {
        font-size: 1.1rem;
        font-weight: 300;
        color: var(--text-secondary);
    }

    /* Admin Stats Grid */
    .admin-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
        gap: 1.5rem;
        margin-top: 1.5rem;
    }
    .stat-card-link { /* Wrapper for the card to make it clickable */
        text-decoration: none;
        color: inherit;
        display: block;
        border-radius: var(--border-radius); /* Match card's radius */
        transition: var(--transition-base);
    }
     .stat-card-link:hover .stat-card { /* Apply card hover when link is hovered */
        transform: translateY(-4px);
        box-shadow: var(--box-shadow-md);
    }
    .stat-card {
        background-color: var(--card-bg);
        border-radius: var(--border-radius);
        padding: 1.25rem; 
        display: flex;
        align-items: center;
        box-shadow: var(--box-shadow); 
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; /* Ensure card itself has transition */
        border-left: 4px solid transparent; 
        cursor: pointer; /* Indicate clickable area */
    }
    /* .stat-card:hover is handled by .stat-card-link:hover .stat-card */

    .stat-card-icon {
        font-size: 1.75rem; 
        margin-right: 1rem;
        padding: 0.6rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 50px; 
        height: 50px;
        flex-shrink: 0;
    }
    .stat-card-icon i { line-height: 1; }
    .stat-card-content .stat-card-value {
        font-size: 2rem; 
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0;
        line-height: 1;
    }
    .stat-card-content .stat-card-label {
        font-size: 0.8rem; 
        color: var(--text-secondary);
        margin-bottom: 0;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .stat-card-total { border-left-color: var(--primary-color); }
    .stat-card-total .stat-card-icon { background-color: rgba(var(--bs-primary-rgb, 31,115,183), 0.1); color: var(--primary-color); }
    .stat-card-open { border-left-color: var(--warning-color); }
    .stat-card-open .stat-card-icon { background-color: rgba(255,193,7, 0.1); color: var(--warning-color); }
    .stat-card-progress { border-left-color: var(--info-color); }
    .stat-card-progress .stat-card-icon { background-color: rgba(23,162,184, 0.1); color: var(--info-color); }
    .stat-card-resolved { border-left-color: var(--success-color); }
    .stat-card-resolved .stat-card-icon { background-color: rgba(40,167,69, 0.1); color: var(--success-color); }

    .animated-stat, .animated-section {
        opacity: 0;
        transform: translateY(20px);
        animation: fadeInUpStagger 0.5s ease-out forwards;
    }
    @keyframes fadeInUpStagger {
        to { opacity: 1; transform: translateY(0); }
    }
    
    .dashboard-action-button { padding: 0.75rem 1.5rem; font-size: 0.95rem; }

    /* Agent & Client Dashboard Sections */
    .dashboard-section .section-title {
        font-size: 1.3rem; 
        color: var(--text-primary);
        margin-bottom: 1.25rem;
        padding-bottom: 0.6rem;
        border-bottom: 1px solid var(--border-color);
    }
    .ticket-list-wrapper .card { 
        animation: slideInTicket 0.4s ease-out forwards;
        opacity: 0;
        transform: translateX(-20px);
        box-shadow: var(--box-shadow-sm); 
    }
    .ticket-list-wrapper .card:hover {
        box-shadow: var(--box-shadow); 
        transform: translateY(-2px);
    }
    {% for i in range(1, 11) %}
    .ticket-list-wrapper .card:nth-child({{i}}) { animation-delay: {{ (i-1) * 0.07 }}s; }
    {% endfor %}

    @keyframes slideInTicket { to { opacity: 1; transform: translateX(0); } }

    .empty-state-card {
        background-color: var(--card-bg);
        border: 1px dashed var(--border-color);
        border-radius: var(--border-radius);
        padding: 2rem;
        text-align: center;
        color: var(--text-secondary);
        margin-top: 1rem;
    }
    .empty-state-card p { font-size: 1rem; margin-bottom: 1.25rem; }

    .dashboard-lower-sections { margin-top: 2.5rem; }
    .dashboard-section-card {
        height: 100%; 
        border-left: 4px solid var(--primary-color-lighter);
    }
    .dashboard-section-card .card-header { font-size: 1rem; font-weight: 500; background-color: #f8f9fa; }
    .dashboard-section-card .card-header i { margin-right: 0.5rem; color: var(--primary-color); }

    .quick-actions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 1rem; }
    .quick-action-item {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        padding: 1rem; background-color: #f9fafb; border-radius: var(--border-radius);
        border: 1px solid var(--border-color); text-align: center; color: var(--text-secondary);
        transition: var(--transition-base), transform 0.15s ease; text-decoration: none !important;
    }
    .quick-action-item:hover { background-color: var(--primary-color); color: white; border-color: var(--primary-color); transform: translateY(-3px); box-shadow: var(--box-shadow-sm); }
    .quick-action-item:hover i { color: white !important; }
    .quick-action-item i { color: var(--primary-color); margin-bottom: 0.75rem; transition: color 0.15s ease; }
    .quick-action-item span { font-size: 0.85rem; font-weight: 500; }

    .recent-activity-body { max-height: 350px; overflow-y: auto; }
    .recent-activity-list { padding-left: 0; list-style: none; margin-bottom: 0; }
    .recent-activity-list li { display: flex; align-items: flex-start; padding: 0.75rem 0.25rem; border-bottom: 1px solid #f1f3f5; }
    .recent-activity-list li:last-child { border-bottom: none; }
    .activity-icon { margin-right: 1rem; flex-shrink: 0; width: 30px; text-align: center; }
    .activity-icon i { font-size: 1.1rem; }
    .activity-content strong { font-weight: 500; color: var(--text-primary); }
    .activity-content small { font-size: 0.75rem; }
    .no-activity { padding: 2rem 0; }
</style>
{% endblock %}