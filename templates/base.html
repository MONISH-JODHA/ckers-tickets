<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{% block title_tag %}{% if title %}{{ title }} - {% endif %}Ticket CMS{% endblock %}</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    {% block head_extra %}{% endblock %}
</head>
<body>
    {# Determine if a System Options sub-page is active for initial sidebar state #}
    {% set system_options_active = request.endpoint in [
        'admin_category_list', 'admin_cloud_provider_list', 'admin_severity_list', 
        'admin_environment_list', 'admin_organization_list', 'admin_form_type_list', 
        'admin_apn_opportunity_list', 'admin_support_modal_list'
    ] %}

    <div class="app-layout">
        <!-- Persistent Sidebar -->
        <nav class="app-sidebar {% if system_options_active %}sidebar-wide-open{% endif %}" id="appSidebar">
            <div class="sidebar-header">
                <a class="navbar-brand" href="{{ url_for('index') }}">
                    <i class="fas fa-ticket-alt"></i>
                    <span class="brand-text">TicketSys</span>
                </a>
                <button class="btn btn-icon d-lg-none" id="sidebarMobileClose" aria-label="Close sidebar">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <ul class="nav flex-column sidebar-nav">
                <li class="nav-item">
                    <a class="nav-link {% if request.endpoint == 'dashboard' %}active{% endif %}" href="{{ url_for('dashboard') }}">
                        <i class="fas fa-tachometer-alt fa-fw"></i><span class="sidebar-item-text">Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.endpoint == 'create_ticket' %}active{% endif %}" href="{{ url_for('create_ticket') }}">
                        <i class="fas fa-plus-circle fa-fw"></i><span class="sidebar-item-text">New Ticket</span>
                    </a>
                </li>

                {% if current_user.is_authenticated %}
                    {% if current_user.is_client %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'my_tickets' %}active{% endif %}" href="{{ url_for('my_tickets') }}">
                            <i class="fas fa-list-ul fa-fw"></i><span class="sidebar-item-text">My Tickets</span>
                        </a>
                    </li>
                    {% endif %}

                    {% if current_user.is_agent or current_user.is_admin %}
                    <li class="nav-item nav-item-heading"><small>AGENT VIEWS</small></li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'agent_ticket_list' and request.view_args.get('view_name') == 'my_unsolved' %}active{% endif %}" href="{{ url_for('agent_ticket_list', view_name='my_unsolved') }}">
                            <i class="fas fa-user-clock fa-fw"></i><span class="sidebar-item-text">My Unsolved</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'agent_ticket_list' and request.view_args.get('view_name') == 'unassigned' %}active{% endif %}" href="{{ url_for('agent_ticket_list', view_name='unassigned') }}">
                            <i class="fas fa-inbox fa-fw"></i><span class="sidebar-item-text">Unassigned</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'agent_ticket_list' and request.view_args.get('view_name') == 'all_unsolved' %}active{% endif %}" href="{{ url_for('agent_ticket_list', view_name='all_unsolved') }}">
                            <i class="fas fa-folder-open fa-fw"></i><span class="sidebar-item-text">All Unsolved</span>
                        </a>
                    </li>
                     <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'agent_ticket_list' and request.view_args.get('view_name') == 'recently_updated' %}active{% endif %}" href="{{ url_for('agent_ticket_list', view_name='recently_updated') }}">
                            <i class="fas fa-history fa-fw"></i><span class="sidebar-item-text">Recently Updated</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'agent_ticket_list' and request.view_args.get('view_name') == 'pending' %}active{% endif %}" href="{{ url_for('agent_ticket_list', view_name='pending') }}">
                            <i class="fas fa-pause-circle fa-fw"></i><span class="sidebar-item-text">Pending Tickets</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'agent_ticket_list' and request.view_args.get('view_name') == 'recently_solved' %}active{% endif %}" href="{{ url_for('agent_ticket_list', view_name='recently_solved') }}">
                            <i class="fas fa-check-circle fa-fw"></i><span class="sidebar-item-text">Recently Solved</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'agent_ticket_list' and request.view_args.get('view_name') == 'current_tasks' %}active{% endif %}" href="{{ url_for('agent_ticket_list', view_name='current_tasks') }}">
                            <i class="fas fa-tasks fa-fw"></i><span class="sidebar-item-text">My Current Tasks</span>
                        </a>
                    </li>
                    {% endif %}

                    <li class="nav-item nav-item-heading"><small>TOOLS</small></li>
                     <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'gdoc_importer_page' %}active{% endif %}" href="{{ url_for('gdoc_importer_page') }}">
                            <i class="fab fa-google-drive fa-fw"></i><span class="sidebar-item-text">GDoc Importer</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'chatbot_page_render' %}active{% endif %}" href="{{ url_for('chatbot_page_render') }}">
                            <i class="fas fa-robot fa-fw"></i><span class="sidebar-item-text">AI Assistant</span>
                        </a>
                    </li>

                    {% if current_user.is_admin %}
                    <li class="nav-item nav-item-heading"><small>ADMINISTRATION</small></li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'admin_user_list' %}active{% endif %}" href="{{ url_for('admin_user_list') }}">
                            <i class="fas fa-users-cog fa-fw"></i><span class="sidebar-item-text">Manage Users</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'admin_all_tickets' %}active{% endif %}" href="{{ url_for('admin_all_tickets') }}">
                            <i class="fas fa-archive fa-fw"></i><span class="sidebar-item-text">All Tickets</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'analytics_dashboard_page' %}active{% endif %}" href="{{ url_for('analytics_dashboard_page') }}">
                            <i class="fas fa-chart-line fa-fw"></i><span class="sidebar-item-text">Analytics</span>
                        </a>
                    </li>
                    <li class="nav-item has-submenu" id="systemOptionsNavItem">
                        <a class="nav-link {% if system_options_active %}active-parent show-submenu{% endif %}" 
                           data-toggle="collapse" href="#adminOptionsCollapse" role="button" 
                           aria-expanded="{% if system_options_active %}true{% else %}false{% endif %}" 
                           aria-controls="adminOptionsCollapse" id="systemOptionsToggle">
                            <i class="fas fa-cogs fa-fw"></i>
                            <span class="sidebar-item-text">System Options</span>
                            <i class="fas fa-chevron-down fa-xs ml-auto expand-icon"></i>
                        </a>
                        <div class="collapse sub-nav-collapse {% if system_options_active %}show{% endif %}" 
                             id="adminOptionsCollapse">
                            <ul class="nav flex-column">
                                <li class="nav-item"><a class="nav-link sub-nav-link {% if request.endpoint == 'admin_category_list' %}active{% endif %}" href="{{ url_for('admin_category_list') }}">Categories</a></li>
                                <li class="nav-item"><a class="nav-link sub-nav-link {% if request.endpoint == 'admin_cloud_provider_list' %}active{% endif %}" href="{{ url_for('admin_cloud_provider_list') }}">Cloud Providers</a></li>
                                <li class="nav-item"><a class="nav-link sub-nav-link {% if request.endpoint == 'admin_severity_list' %}active{% endif %}" href="{{ url_for('admin_severity_list') }}">Severities</a></li>
                                <li class="nav-item"><a class="nav-link sub-nav-link {% if request.endpoint == 'admin_environment_list' %}active{% endif %}" href="{{ url_for('admin_environment_list') }}">Environments</a></li>
                                <li class="nav-item"><a class="nav-link sub-nav-link {% if request.endpoint == 'admin_organization_list' %}active{% endif %}" href="{{ url_for('admin_organization_list') }}">Organizations</a></li>
                                <li class="nav-item"><a class="nav-link sub-nav-link {% if request.endpoint == 'admin_form_type_list' %}active{% endif %}" href="{{ url_for('admin_form_type_list') }}">Form Types</a></li>
                                <li class="nav-item"><a class="nav-link sub-nav-link {% if request.endpoint == 'admin_apn_opportunity_list' %}active{% endif %}" href="{{ url_for('admin_apn_opportunity_list') }}">APN Opportunities</a></li>
                                <li class="nav-item"><a class="nav-link sub-nav-link {% if request.endpoint == 'admin_support_modal_list' %}active{% endif %}" href="{{ url_for('admin_support_modal_list') }}">Support Modals</a></li>
                            </ul>
                        </div>
                    </li>
                    {% endif %}
                {% endif %}
            </ul>
            <div class="sidebar-footer">
                {% if current_user.is_authenticated %}
                    <div class="user-info">
                        <img src="https://ui-avatars.com/api/?name={{ current_user.username[0]|upper }}&background=random&color=fff&size=30&rounded=true" alt="User" class="avatar-sm">
                        <span class="username-text">{{ current_user.username }}</span>
                    </div>
                    <a href="{{ url_for('logout') }}" class="btn btn-sm btn-outline-light logout-btn" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                        <span class="logout-text">Logout</span>
                    </a>
                {% else %}
                    <a href="{{ url_for('login') }}" class="btn btn-primary btn-block">Login</a>
                    <a href="{{ url_for('register_client') }}" class="btn btn-outline-light btn-block mt-2">Register</a>
                {% endif %}
            </div>
        </nav>
   
        <!-- Main Content Area -->
        <div class="app-main {% if system_options_active %}sidebar-wide-open-main{% endif %}" id="appMain">
            <header class="app-header">
                <button class="btn btn-icon d-lg-none" id="sidebarMobileToggle" aria-label="Toggle sidebar">
                    <i class="fas fa-bars"></i>
                </button>
                
                {# This block will be replaced by child templates if they define it #}
                {# Otherwise, the default structure with page_actions_placeholder is used #}
                {% block content_header %}
                    <div class="content-header-bar">
                        {% if title %} 
                            <h1 class="content-title">{{ title }}</h1>
                        {% else %}
                             <div></div> {# Empty div to help flexbox alignment if no title #}
                        {% endif %}
                        <div class="page-actions-placeholder">
                             {% block page_actions %}{% endblock %} {# Child templates fill this for buttons #}
                        </div>
                    </div>
                {% endblock content_header %}

                 <div class="top-right-actions">
                    {# Future placeholder for global search, notifications, user dropdown etc. #}
                 </div>
            </header>

            <main class="app-content">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        <div class="flash-messages-container">
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">×</span>
                                </button>
                            </div>
                        {% endfor %}
                        </div>
                    {% endif %}
                {% endwith %}
                
                {# If a child template did not override content_header, this is the main content area #}
                {# If it did, then this block is where the rest of its content goes after its header #}
                {% block content %}{% endblock %}
            </main>
            
            <footer class="app-footer">
                <div class="container-fluid">
                    <span class="text-muted">© {{ current_year }} TicketSys Advanced. All rights reserved.</span>
                </div>
            </footer>
        </div>
    </div>
    <div class="sidebar-backdrop" id="sidebarBackdrop"></div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    {% block scripts %}{% endblock %}
    <script>
        $(document).ready(function () {
            const appSidebar = $('#appSidebar');
            const appMain = $('#appMain');
            const systemOptionsToggle = $('#systemOptionsToggle');
            const adminOptionsCollapse = $('#adminOptionsCollapse');
            
            const isSystemOptionsPage = {{ system_options_active | tojson }};

            function setSidebarWideState(isWide) {
                if (isWide) {
                    appSidebar.addClass('sidebar-wide-open');
                    appMain.addClass('sidebar-wide-open-main');
                } else {
                    appSidebar.removeClass('sidebar-wide-open');
                    appMain.removeClass('sidebar-wide-open-main');
                }
            }

            // Initial state on page load:
            if (isSystemOptionsPage) {
                setSidebarWideState(true); // Sidebar starts wide if on a system options page
                systemOptionsToggle.addClass('show-submenu').attr('aria-expanded', 'true').removeClass('collapsed');
                // adminOptionsCollapse should have 'show' class from Jinja
            } else {
                // Ensure it's not wide if not a system options page
                setSidebarWideState(false); 
                // And ensure toggle reflects collapsed state if submenu isn't shown by Jinja
                if (!adminOptionsCollapse.hasClass('show')) {
                    systemOptionsToggle.removeClass('show-submenu').attr('aria-expanded', 'false').addClass('collapsed');
                }
            }

            systemOptionsToggle.on('click', function (e) {
                const isCurrentlyOpen = adminOptionsCollapse.hasClass('show');
                if (!isCurrentlyOpen) { // About to open
                    setSidebarWideState(true);
                } else { // About to close
                    // Only shrink if we are NOT currently on a system options page.
                    // If we are, it should remain wide even if user manually collapses.
                    if (!isSystemOptionsPage) {
                        setSidebarWideState(false);
                    }
                }
            });
            
            adminOptionsCollapse.on('shown.bs.collapse', function () {
                systemOptionsToggle.addClass('show-submenu');
                // If shown, ensure sidebar is wide (handles cases like direct URL nav to sub-item)
                setSidebarWideState(true); 
            });

            adminOptionsCollapse.on('hidden.bs.collapse', function () {
                systemOptionsToggle.removeClass('show-submenu');
                // If the sub-menu is hidden, AND we are not on a system options page, shrink the sidebar.
                if (!isSystemOptionsPage) { 
                    setSidebarWideState(false);
                }
                // If we ARE on a system options page, the sidebar remains wide due to the Jinja class.
            });

            // Clicking any sub-menu link will cause navigation.
            // On the new page, `isSystemOptionsPage` will be re-evaluated.
            // If the new page IS a system options page, sidebar will be wide due to Jinja.
            // If the new page IS NOT a system options page, the sidebar will be narrow.
            $('#adminOptionsCollapse .sub-nav-link').on('click', function() {
                // No need to call setSidebarWideState(false) here for immediate shrink,
                // as page navigation will handle the correct state.
                // The goal is to keep it wide while navigating WITHIN system options.
            });
            
            // For any OTHER top-level nav link (not system options)
            $('.sidebar-nav > .nav-item > .nav-link').not(systemOptionsToggle).on('click', function() {
                // If this click navigates away from system options, the sidebar should shrink.
                // This happens naturally on page reload as `isSystemOptionsPage` will be false.
                // For immediate UX, if the system options *was* open, we can trigger its collapse.
                if (adminOptionsCollapse.hasClass('show')) {
                    adminOptionsCollapse.collapse('hide'); // This will trigger hidden.bs.collapse, which then shrinks if not on sys page.
                } else {
                     // If some other future menu could make it wide, handle here.
                    setSidebarWideState(false); // Default to narrow if not system options context.
                }
            });
            
            // Mobile sidebar toggle logic
            const sidebarMobileToggle = $('#sidebarMobileToggle');
            const sidebarMobileClose = $('#sidebarMobileClose');
            const sidebarBackdrop = $('#sidebarBackdrop');

            if (sidebarMobileToggle.length) {
                sidebarMobileToggle.on('click', function() {
                    appSidebar.addClass('sidebar-mobile-active');
                    sidebarBackdrop.addClass('active');
                });
            }
            if (sidebarMobileClose.length) {
                sidebarMobileClose.on('click', function() {
                    appSidebar.removeClass('sidebar-mobile-active');
                    sidebarBackdrop.removeClass('active');
                });
            }
            if (sidebarBackdrop.length) {
                sidebarBackdrop.on('click', function() {
                    appSidebar.removeClass('sidebar-mobile-active');
                    sidebarBackdrop.removeClass('active');
                });
            }
        });
    </script>
</body>
</html>